# Описание приложение

Приолжение является балансировщиком нагрузки с опциональным подключением ограничителя трафка.

# Сборка и запуск

Сборка и запуск приложения осуществляются с помощью утилиты `make`. `Makefile` в корне проекта содержит определенные по умолчанию параметры запуска:

| Параметр | Описание                                                                   | Значение по умолчанию |
| -------- | -------------------------------------------------------------------------- | --------------------- |
| PORT     | HTTP порт приложения                                                       | 8888                  |
| HOST     | HTTP хост приложения                                                       | localhost             |
| CONFIG   | Путь до файла с конфигурацией серверов для маршрутизации входящих запросов | ./config/config.yaml  |
| RLIMIT   | Флаг наличия ограничителя трафика                                          | true                  |
| RLSTORE  | Путь до файла БД                                                           | ratelimiter.db        |

Для сборки и запуска приложеня требуется выполнить команду для сборки

```
make build
```

И команду для запуска

```
make run
```

# Описание

## Балансировщик нагрузки

[Код](./internal/balancer/)

### Конфигурация

В конфигурационном `yaml` файле описываются URL серверов для адресации запросов в формате:

```yaml
servers:
  - http://localhost:9001
  - http://localhost:9002
  - http://localhost:9003
```

При запуске приложения происходит считывания файла конфигурации и загрузка серверов в [пул](./internal/balancer/pool/dynamic_pool/pool.go).

Конфигурация не зависит от кода. Для обновления пула серверов в `runtime` нужно использовать сигнал ОС `SIGHUP`:

```
kill -SIGHUP $(lsof -t -i :<PORT>)
```

Сигнал [будет обработан](./internal/balancer/pool/config_watcher/watcher.go) и пул обновлен.

### Проксирование

За счет инверсии зависимостей и использования [балансировщик](./internal/balancer/balancer/balancer.go) является гибким и не зависит от реализации алгоритма планирования, пула серверов или самой программной реализации сервера непосредственно.

Если сервер, на который был адресован запрос, выдает вынутреннюю ошибку `5xx` происходит автоматический перевыбор сервера

## Ограничитель трафика

[Код](./internal/ratelimiter/)

Ограничитель трафика использует настройки по умолчанию, также описанные в файле конфигурации

```yaml
rate_limiter:
  default_capacity: 1
  default_refill_rate: 5s
```

### API

Для добавления и удаления IP адресов клиентов, которые могут делать запросы, реализован API

#### POST /clients

```json
{
  "ip": "127.0.0.1",
  "capacity": 5,
  "refill_every": "2s"
}
```

#### DELETE /clients

```json
{
  "ip": "127.0.0.1"
}
```

Для персистентного хранения данных используется СУБД `SQLite`
